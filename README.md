# FonlineWeb

FonlineWeb — это браузерная MMO по мотивам Fallout 2 с изометрической графикой и многопользовательским взаимодействием. Проект находится на этапе начальной разработки.

## Структура репозитория

- `server/` — серверная часть на TypeScript (Node.js) с поддержкой HTTP API, WebSocket и динамической подгрузкой игровых скриптов.
- `server/game-scripts/` — каталог игровых скриптов, совместимых с системой `include` оригинальной игры.
- `client/` — экспериментальный клиент для визуализации гекс-сетки и отладки перемещений.
- `docks/` — дополнительные материалы и документация.

## Быстрый старт (локально)

```bash
cd server
cp .env.example .env
npm install
npm run dev
```

По умолчанию сервер поднимается на `http://localhost:8080` и обслуживает HTTP API, WebSocket и статический клиент в одном процессе. После запуска откройте `http://localhost:8080` в браузере, чтобы увидеть тестовый интерфейс. Для корректной работы требуется доступная база данных PostgreSQL (значение `DATABASE_URL`). При необходимости путь к статическим файлам можно переопределить через переменную окружения `PUBLIC_DIR`.

## Гексовая карта и перемещение

Сервер поддерживает прототип игрового мира размером 50×50 гексов в axial-координатах с even-q раскладкой. При подключении по WebSocket игрок автоматически спавнится в центре карты и может перемещаться в шести направлениях. Доступные значения направления: `east`, `northEast`, `northWest`, `west`, `southWest`, `southEast`.

API WebSocket:

- `player:move` — перемещение персонажа. Тело сообщения: `{ "direction": "northEast" }`.
- `player:setName` — переименование персонажа. Тело сообщения: `{ "name": "Имя" }`.

Сервер рассылет широковещательные события `world:*` об изменении состояния мира всем подключённым клиентам.

## Тестовый клиент

В каталоге `client/` находится интерактивный прототип интерфейса: полноэкранная гекс-сцена с HUD поверх поля, включающим компактную панель действий в левом нижнем углу и вытянутый чат вдоль нижнего края. Дополнительные окна (инвентарь, персонаж, карта, настройки, экипировка) появляются поверх игры только по запросу. Во время разработки сервер сам обслуживает файлы из этого каталога — дополнительных настроек не требуется.

Основные возможности прототипа:

- перемещение персонажа кликом или касанием по соседнему гексу с подсветкой текущей позиции;
- дополнительная поддержка управления клавишами `Q`, `W`, `E`, `A`, `S`, `D` для отладки на десктопе;
- чат-заглушка в стиле Fallout, занимающая большую часть нижней панели, и компактный блок действий в левом нижнем углу с обратной связью о нажатиях;
- всплывающие поверх игровой сцены окна-заглушки для инвентаря, карты, персонажа, экипировки и настроек, которые открываются и закрываются по клику по кнопкам панели действий или клавише `Esc`.

Интерфейс адаптирован под мобильные устройства и сохраняет тёмную Fallout-стилистику (чёрный фон, зелёно-жёлтые акценты).

### Конфигурация интерфейса

Клиент читает внешнюю конфигурацию HUD из файла [`client/ui/default.ini`](client/ui/default.ini). Формат идентичен оригинальным ini-файлам Fallout: `ключ = значение`, секции в квадратных скобках, комментарии начинаются с `#`. На текущем этапе через конфиг можно:

- переименовывать заголовки и подписи панелей в блоках `[Meta]`, `[Chat]`, `[CommandBar]`;
- задавать размеры и отступы HUD числовыми значениями, которые автоматически трактуются как пиксели (например, `Chat.Width = 640`);
- управлять набором кнопок и горячих клавиш панели действий в секциях `Action.*` (`Hotkey = KeyI` и т. п.);
- описывать всплывающие окна в секциях `Overlay.*`, указывая текст и списки заметок через `Notes`.

За загрузку и парсинг отвечает модуль `client/ui/configLoader.js`. Если файл отсутствует или содержит ошибки, клиент использует встроенную конфигурацию по умолчанию и продолжает работу без перезагрузки.

## Декодер FR файлов

Для работы с оригинальными анимациями добавлен CLI-скрипт декодирования Fallout FR с применением переданной палитры JASC-PAL. Он извлекает кадры в формате PNG и сохраняет метаданные.

```bash
cd server
npm run decode-fr -- path/to/animation.fr --output ./decoded/animation
```

Опции:

- `--skip-images` — не сохранять PNG-кадры, только метаданные.
- `--skip-metadata` — не сохранять `metadata.json`.
- `-q/--quiet` — отключить подробный вывод.

По умолчанию прозрачность берётся из нулевого индекса палитры, а PNG-файлы группируются по направлениям (`direction_0` ... `direction_5`).

## Docker

Для запуска в контейнере предусмотрен `Dockerfile`, который собирает сервер и статический клиент в один образ. Пример сборки:

```bash
docker build -t fonlineweb --file server/Dockerfile .
```

После сборки контейнер можно запустить командой

```bash
docker run --rm -p 8080:8080 --env DATABASE_URL=... fonlineweb
```

Контейнер слушает порт, указанный в переменной окружения `PORT` (по умолчанию `8080`), и отдаёт веб-интерфейс на корневом адресе.

## Развёртывание на Render

В репозитории присутствует файл [`render.yaml`](render.yaml) для деплоя в одном веб-сервисе Render. Он использует Docker-окружение и тот же `Dockerfile`, что и локальный запуск.

1. Создайте новое Web-приложение в Render и укажите репозиторий.
2. Render автоматически распознает `render.yaml` и предложит создать сервис `fonlineweb`.
3. Укажите секрет `DATABASE_URL` со строкой подключения к PostgreSQL.
4. После деплоя приложение будет доступно по адресу вида `https://<имя-сервиса>.onrender.com` и будет обслуживать API, статический клиент и WebSocket на одном порту.

## План разработки

План и прогресс ведутся в файле [TASKS.md](TASKS.md).

